"use strict";(self["webpackChunkdolphin"]=self["webpackChunkdolphin"]||[]).push([[183],{1728:(e,s,t)=>{e.exports=t.p+"img/Add.1f261cbb.svg"},4181:(e,s,t)=>{t.r(s),t.d(s,{default:()=>zs});var a=t(641);const i={class:"page"},l={class:"assessments-table-outer"};function r(e,s,t,r,n,o){const d=(0,a.g2)("OrganizationAdminAssessmentsCard"),m=(0,a.g2)("UserAssessment"),u=(0,a.g2)("MainLayout");return(0,a.uX)(),(0,a.Wv)(u,null,{default:(0,a.k6)(()=>[(0,a.Lk)("div",i,[(0,a.Lk)("div",l,[o.isOrganizationAdmin?((0,a.uX)(),(0,a.Wv)(d,{key:0})):o.isUser?((0,a.uX)(),(0,a.Wv)(m,{key:1})):(0,a.Q3)("",!0)])])]),_:1})}var n=t(4631),o=t(33),d=t(1728);const m=t.p+"img/Schedule.2140b6c7.svg",u={class:"assessments-card"},c={class:"assessments-header-row"},h={class:"assessments-header-actions"},p={class:"table-container"},g={class:"table"},b=["onClick"],y={key:0,class:"scheduled-details"},f=["id","data-assessment-id","onClick"],k=["alt"],v={key:1,class:"modal-overlay"};function w(e,s,t,i,l,r){const n=(0,a.g2)("TableHeader"),w=(0,a.g2)("CreateAssessmentModal"),A=(0,a.g2)("ScheduleAssessmentModal"),S=(0,a.g2)("ScheduleDetailsModal"),_=(0,a.g2)("Pagination");return(0,a.uX)(),(0,a.CE)(a.FK,null,[(0,a.Lk)("div",u,[(0,a.Lk)("div",c,[s[3]||(s[3]=(0,a.Lk)("div",null,null,-1)),(0,a.Lk)("div",h,[(0,a.Lk)("button",{class:"btn btn-primary",onClick:s[0]||(s[0]=e=>l.showCreateModal=!0)},[...s[2]||(s[2]=[(0,a.Lk)("img",{src:d,alt:"Add",style:{width:"18px",height:"18px","vertical-align":"middle","margin-right":"8px"}},null,-1),(0,a.eW)(" Create Assessments ",-1)])])])]),(0,a.Lk)("div",p,[(0,a.Lk)("table",g,[s[4]||(s[4]=(0,a.Lk)("colgroup",null,[(0,a.Lk)("col",{style:{width:"25%"}}),(0,a.Lk)("col",{style:{width:"75%"}})],-1)),(0,a.bF)(n,{columns:[{label:"Assessment Name",key:"name",style:"width: 30%"},{label:"Actions",key:"actions",style:"width: 70%"}]}),(0,a.Lk)("tbody",null,[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(r.paginatedAssessments,e=>((0,a.uX)(),(0,a.CE)("tr",{key:e.id},[(0,a.Lk)("td",null,[(0,a.Lk)("button",{class:"assessment-link",onClick:s=>r.goToSummary(e)},(0,o.v_)(e.name),9,b)]),(0,a.Lk)("td",null,[e.schedule?((0,a.uX)(),(0,a.CE)("div",y)):(0,a.Q3)("",!0),(0,a.Lk)("button",{class:"schedule-btn",id:"schedule-btn-"+e.id,"data-assessment-id":e.id,ref_for:!0,ref:"scheduleBtn-"+e.id,onClick:s=>r.onScheduleButtonClick(e),style:{"min-width":"135px","max-width":"135px"}},[(0,a.Lk)("img",{src:m,alt:e.schedule?"Details":"Schedule",style:{"margin-right":"6px",width:"18px",height:"18px","vertical-align":"middle",display:"inline-block"}},null,8,k),(0,a.eW)(" "+(0,o.v_)(e.schedule?"Details":"Schedule"),1)],8,f)])]))),128))])])]),l.showCreateModal?((0,a.uX)(),(0,a.Wv)(w,{key:0,questions:l.questions,onClose:r.closeCreateModal,onAssessmentCreated:r.handleAssessmentCreated,onValidationError:r.handleValidationError,onError:r.handleError},null,8,["questions","onClose","onAssessmentCreated","onValidationError","onError"])):(0,a.Q3)("",!0),l.showScheduleModal?((0,a.uX)(),(0,a.CE)("div",v,[(0,a.bF)(A,{assessmentName:l.selectedAssessment&&l.selectedAssessment.name,assessment_id:l.selectedAssessment&&l.selectedAssessment.id,onClose:r.closeScheduleModal,onSchedule:r.handleScheduleAssessment},null,8,["assessmentName","assessment_id","onClose","onSchedule"])])):(0,a.Q3)("",!0),l.showScheduleDetailsModal?((0,a.uX)(),(0,a.Wv)(S,{key:2,scheduleDetails:l.scheduleDetails,allGroups:l.allGroups,allMembers:l.allMembers,onClose:r.closeScheduleDetailsModal},null,8,["scheduleDetails","allGroups","allMembers","onClose"])):(0,a.Q3)("",!0)]),(0,a.bF)(_,{pageSize:l.pageSize,pageSizes:[10,25,100],showPageDropdown:l.showPageDropdown,currentPage:l.currentPage,totalPages:r.totalPages,onTogglePageDropdown:s[1]||(s[1]=e=>l.showPageDropdown=!l.showPageDropdown),onSelectPageSize:r.selectPageSize,onGoToPage:r.goToPage},null,8,["pageSize","showPageDropdown","currentPage","totalPages","onSelectPageSize","onGoToPage"])],64)}var A=t(733),S=t(3751);const _={class:"modal-card",style:{"max-width":"900px"}},D={key:0,class:"loading-container"},x={key:1,class:"scheduled-info"},C={class:"modal-form-actions"},L={class:"modal-form-row-div",style:{flex:"1","min-width":"0"}},E={class:"modal-form-row-div",style:{flex:"1","min-width":"0"}},M={class:"modal-form-row-div",style:{flex:"1","min-width":"0"}},N={class:"modal-form-row-div",style:{flex:"1","min-width":"0"}},$={class:"modal-form-actions"},T=["disabled"];function z(e,s,t,i,l,r){const n=(0,a.g2)("FormLabel"),d=(0,a.g2)("MultiSelectDropdown"),m=(0,a.g2)("FormRow"),u=(0,a.g2)("FormInput");return(0,a.uX)(),(0,a.CE)("div",{class:"modal-overlay",onClick:s[7]||(s[7]=(0,S.D$)(s=>e.$emit("close"),["self"]))},[(0,a.Lk)("div",_,[(0,a.Lk)("button",{class:"modal-close-btn",onClick:s[0]||(s[0]=s=>e.$emit("close"))}," × "),s[18]||(s[18]=(0,a.Lk)("div",{class:"modal-title"},"Schedule an Assessment",-1)),s[19]||(s[19]=(0,a.Lk)("div",{class:"modal-desc",style:{"font-size":"1.2rem !important","margin-bottom":"32px !important"}}," Schedule this assessment to be sent to members of your organization. ",-1)),l.scheduledLoading||l.loadingGroups||l.loadingMembers?((0,a.uX)(),(0,a.CE)("div",D," Loading... ")):"scheduled"===l.scheduledStatus&&l.scheduledDetails?((0,a.uX)(),(0,a.CE)("div",x,[s[11]||(s[11]=(0,a.Lk)("h3",null,"Assessment Already Scheduled",-1)),s[12]||(s[12]=(0,a.Lk)("p",null,"This assessment is scheduled to be sent on:",-1)),(0,a.Lk)("p",null,[s[8]||(s[8]=(0,a.Lk)("strong",null,"Date:",-1)),(0,a.eW)(" "+(0,o.v_)(new Date(l.scheduledDetails.send_at).toLocaleDateString()),1)]),(0,a.Lk)("p",null,[s[9]||(s[9]=(0,a.Lk)("strong",null,"Time:",-1)),(0,a.eW)(" "+(0,o.v_)(new Date(l.scheduledDetails.send_at).toLocaleTimeString()),1)]),(0,a.Lk)("p",null,[s[10]||(s[10]=(0,a.Lk)("strong",null,"To:",-1)),(0,a.eW)(" "+(0,o.v_)(l.scheduledDetails.recipient_email),1)]),(0,a.Lk)("div",C,[(0,a.Lk)("button",{type:"button",class:"org-edit-cancel",onClick:s[1]||(s[1]=s=>e.$emit("close"))}," Close ")])])):((0,a.uX)(),(0,a.CE)("form",{key:2,class:"modal-form",onSubmit:s[6]||(s[6]=(0,S.D$)((...e)=>r.schedule&&r.schedule(...e),["prevent"]))},[(0,a.bF)(m,{class:"modal-form-row",style:{"margin-bottom":"0 !important",display:"flex",gap:"18px","align-items":"flex-start","flex-direction":"row"}},{default:(0,a.k6)(()=>[(0,a.Lk)("div",L,[(0,a.bF)(n,{style:{"font-size":"1rem !important",margin:"0 0 6px 0 !important"}},{default:(0,a.k6)(()=>[...s[13]||(s[13]=[(0,a.eW)("Select Group",-1)])]),_:1}),(0,a.bF)(d,{options:l.groups,selectedItems:Array.isArray(l.selectedGroupIds)?l.selectedGroupIds:[],"onUpdate:selectedItems":r.onGroupSelection,placeholder:"Select one or more groups",enableSelectAll:!0},null,8,["options","selectedItems","onUpdate:selectedItems"])]),(0,a.Lk)("div",E,[(0,a.bF)(n,{style:{"font-size":"1rem !important",margin:"0 0 6px 0 !important"}},{default:(0,a.k6)(()=>[...s[14]||(s[14]=[(0,a.eW)("Select Member",-1)])]),_:1}),(0,a.bF)(d,{options:r.filteredMembers,selectedItems:Array.isArray(l.selectedMemberIds)?l.selectedMemberIds:[],"onUpdate:selectedItems":s[2]||(s[2]=e=>l.selectedMemberIds=e),placeholder:"Select one or more members",enableSelectAll:!0},null,8,["options","selectedItems"])])]),_:1}),(0,a.bF)(m,{class:"modal-form-row",style:{"margin-bottom":"0 !important",display:"flex",gap:"18px","align-items":"flex-start","flex-direction":"row"}},{default:(0,a.k6)(()=>[(0,a.Lk)("div",M,[(0,a.bF)(n,{style:{"font-size":"1rem !important",margin:"0 0 6px 0 !important"}},{default:(0,a.k6)(()=>[...s[15]||(s[15]=[(0,a.eW)("Select Date",-1)])]),_:1}),(0,a.bF)(u,{modelValue:l.scheduleDate,"onUpdate:modelValue":s[3]||(s[3]=e=>l.scheduleDate=e),type:"date",required:""},null,8,["modelValue"])]),(0,a.Lk)("div",N,[(0,a.bF)(n,{style:{"font-size":"1rem !important",margin:"0 0 6px 0 !important"}},{default:(0,a.k6)(()=>[...s[16]||(s[16]=[(0,a.eW)("Select Time",-1)])]),_:1}),(0,a.bF)(u,{modelValue:l.scheduleTime,"onUpdate:modelValue":s[4]||(s[4]=e=>l.scheduleTime=e),type:"time",required:""},null,8,["modelValue"])])]),_:1}),(0,a.Lk)("div",$,[(0,a.Lk)("button",{type:"submit",class:"btn btn-primary",disabled:l.isSubmitting},[s[17]||(s[17]=(0,a.Lk)("i",{class:"fas fa-calendar-check"},null,-1)),(0,a.eW)(" "+(0,o.v_)(l.isSubmitting?"Scheduling...":"Schedule"),1)],8,T),(0,a.Lk)("button",{type:"button",class:"org-edit-cancel",onClick:s[5]||(s[5]=s=>e.$emit("close"))}," Cancel ")])],32))])])}var X=t(5298),F=t(2124),I=t(4117),W=t(7420),P=t(4335),G=t(3193),q=t(3080);const B={name:"ScheduleAssessmentModal",components:{FormInput:X.A,FormLabel:F.A,MultiSelectDropdown:I.A,FormRow:W.A},props:{assessment_id:{type:[Number,String],required:!0}},setup(){const e=(0,q.d)();return{toast:e}},data(){return{scheduledLoading:!0,scheduledStatus:null,scheduledDetails:null,loadingGroups:!0,loadingMembers:!0,isSubmitting:!1,groups:[],members:[],selectedGroupIds:[],selectedMemberIds:[],scheduleDate:"",scheduleTime:""}},computed:{filteredMembers(){if(0===this.selectedGroupIds.length)return this.members;const e=this.selectedGroupIds.map(e=>e.id);return this.members.filter(s=>s.group_ids.some(s=>e.includes(s)))}},methods:{onGroupSelection(e){this.selectedGroupIds=e,this.selectedMemberIds=[]},async schedule(){this.isSubmitting=!0;try{const e=G["default"].get("authToken"),s="http://127.0.0.1:8000",t={assessment_id:this.assessment_id,date:this.scheduleDate,time:this.scheduleTime,group_ids:this.selectedGroupIds.map(e=>e.id),member_ids:this.selectedMemberIds.map(e=>e.id)};await P.A.post(`${s}/api/assessment-schedules`,t,{headers:{Authorization:`Bearer ${e}`}}),this.toast.add({severity:"success",summary:"Success",detail:"Assessment scheduled successfully!",life:3e3}),this.$emit("close")}catch(e){console.error("Failed to schedule assessment:",e);const s=e.response?.data?.message||"Failed to schedule assessment.";this.toast.add({severity:"error",summary:"Error",detail:s,life:4e3})}finally{this.isSubmitting=!1}},async checkExistingSchedule(){if(!this.assessment_id)return console.warn("[ScheduleAssessmentModal] assessment_id is missing."),void(this.scheduledLoading=!1);this.scheduledLoading=!0;try{const e=G["default"].get("authToken"),s="http://127.0.0.1:8000",t=`${s}/api/scheduled-email/show?assessment_id=${encodeURIComponent(this.assessment_id)}`,a=await P.A.get(t,{headers:{Authorization:`Bearer ${e}`}});a.data?.scheduled&&a.data?.data?(this.scheduledStatus="scheduled",this.scheduledDetails=a.data.data):this.scheduledStatus=null}catch(e){this.scheduledStatus=null,console.error("Error checking schedule status:",e)}finally{this.scheduledLoading=!1}},async fetchGroups(){const e=G["default"].get("authToken"),s="http://127.0.0.1:8000",t=await P.A.get(`${s}/api/groups`,{headers:{Authorization:`Bearer ${e}`}}),a=t.data?.data||t.data||[];return a.map(e=>({id:e.id,name:e.name}))},async fetchMembers(){const e=G["default"].get("authToken"),s="http://127.0.0.1:8000",t=await P.A.get(`${s}/api/members`,{headers:{Authorization:`Bearer ${e}`}}),a=t.data?.data||t.data||[];return a.map(e=>({id:e.id,name:`${e.first_name} ${e.last_name}`.trim(),email:e.email,group_ids:Array.isArray(e.group_ids)?e.group_ids:[]}))},async fetchModalData(){this.loadingGroups=!0,this.loadingMembers=!0;try{const[e,s]=await Promise.all([this.fetchGroups(),this.fetchMembers()]);this.groups=e,this.members=s}catch(e){console.error("Error fetching modal data:",e),this.toast.add({severity:"error",summary:"Error",detail:"Could not load groups or members.",life:4e3})}finally{this.loadingGroups=!1,this.loadingMembers=!1}}},async mounted(){this.checkExistingSchedule(),this.fetchModalData()}};var Q=t(6262);const U=(0,Q.A)(B,[["render",z],["__scopeId","data-v-7a41248c"]]),O=U,R={key:0,class:"modal-card",style:{"max-width":"900px",width:"90%"}},j={class:"notifications-controls"},K={class:"notifications-tabs"},V={key:0},J={class:"modal-title schedule-header",style:{"font-size":"20px","font-weight":"450"}},H={class:"schedule-header-left"},Y={class:"schedule-assessment-name",style:{display:"inline-block","vertical-align":"middle","max-width":"520px","margin-right":"12px"}},Z={class:"schedule-assessment-name",style:{display:"inline-block","vertical-align":"middle","margin-left":"12px"}},ee={class:"schedule-header-right"},se={key:0},te={key:0,class:"status-green"},ae={key:1,class:"status-yellow"},ie={key:2},le={key:0,class:"status-yellow"},re={key:1,class:"status-red"},ne={key:3,class:"status-yellow"},oe={key:1},de={key:0,class:"status-yellow"},me={key:1,class:"status-red"},ue={key:0},ce={class:"detail-row"},he={class:"detail-table",style:{width:"100% !important","max-width":"800px !important",margin:"0 !important"}},pe={class:"recipient-table-wrap",style:{"overflow-x":"auto","-webkit-overflow-scrolling":"touch",width:"100%"}},ge={key:0,class:"recipient-table compact",style:{width:"100%","min-width":"500px"}},be=["rowspan"],ye={style:{padding:"0px 8px !important"}},fe={key:1},ke={key:1},ve={class:"modal-title schedule-header",style:{"font-size":"20px","font-weight":"450"}},we={class:"schedule-header-left"},Ae={class:"schedule-assessment-name",style:{display:"inline-block","vertical-align":"middle","max-width":"520px","margin-right":"12px"}},Se={class:"schedule-assessment-name",style:{display:"inline-block","vertical-align":"middle","margin-left":"12px"}},_e={class:"schedule-header-right"},De={key:0},xe={key:0,class:"status-green"},Ce={key:1,class:"status-yellow"},Le={key:2},Ee={key:0,class:"status-yellow"},Me={key:1,class:"status-red"},Ne={key:3,class:"status-yellow"},$e={key:1},Te={key:0,class:"status-yellow"},ze={key:1,class:"status-red"},Xe={class:"detail-row"},Fe={class:"detail-table",style:{width:"100% !important","max-width":"800px !important",margin:"0 !important"}},Ie={class:"recipient-table-wrap",style:{"overflow-x":"auto","-webkit-overflow-scrolling":"touch",width:"100%"}},We={key:0,class:"recipient-table compact",style:{width:"100%","min-width":"500px"}},Pe={key:1,class:"no-data"};function Ge(e,s,t,i,l,r){const n=(0,a.g2)("TableHeader");return(0,a.uX)(),(0,a.CE)("div",{class:"modal-overlay",onClick:s[3]||(s[3]=(0,S.D$)(s=>e.$emit("close"),["self"]))},[t.scheduleDetails?((0,a.uX)(),(0,a.CE)("div",R,[(0,a.Lk)("button",{class:"modal-close",onClick:s[0]||(s[0]=s=>e.$emit("close"))}," × "),s[10]||(s[10]=(0,a.Lk)("div",{class:"modal-title"},"Scheduled Assessment Details",-1)),s[11]||(s[11]=(0,a.Lk)("div",{class:"modal-desc"}," Details for the selected scheduled assessment. ",-1)),(0,a.Lk)("div",j,[(0,a.Lk)("div",K,[(0,a.Lk)("button",{class:(0,o.C4)(["notifications-tab-btn-left",{active:"Group Wise"===l.tab}]),onClick:s[1]||(s[1]=e=>l.tab="Group Wise")}," Group Wise ",2),(0,a.Lk)("button",{class:(0,o.C4)(["notifications-tab-btn-right",{active:"Member Wise"===l.tab}]),onClick:s[2]||(s[2]=e=>l.tab="Member Wise"),"min-width":"320px"}," Member Wise ",2)])]),"Group Wise"===l.tab?((0,a.uX)(),(0,a.CE)("div",V,[s[6]||(s[6]=(0,a.Lk)("br",null,null,-1)),(0,a.Lk)("div",J,[(0,a.Lk)("div",H,[(0,a.Lk)("div",null,[(0,a.Lk)("div",Y,(0,o.v_)(t.scheduleDetails.assessment.name),1),s[4]||(s[4]=(0,a.eW)(" - ",-1)),(0,a.Lk)("div",Z,(0,o.v_)(r.formatLocalDateTime(t.scheduleDetails.schedule.date,t.scheduleDetails.schedule.time)),1)])]),(0,a.Lk)("div",ee,[t.scheduleDetails.emails&&t.scheduleDetails.emails.length?((0,a.uX)(),(0,a.CE)("span",se,[r.filteredEmails.length&&r.filteredEmails.every(e=>e.sent)?((0,a.uX)(),(0,a.CE)("span",te,"Sent")):r.filteredEmails.length&&r.filteredEmails.some(e=>!e.sent)&&r.filteredEmails.some(e=>e.sent)?((0,a.uX)(),(0,a.CE)("span",ae,"Scheduled")):r.filteredEmails.length&&r.filteredEmails.every(e=>!e.sent)?((0,a.uX)(),(0,a.CE)("span",ie,[r.filteredEmails.some(e=>{const[s,t]=(e.send_at||"").split(" "),[a,i,l]=s?s.split("-"):[],[r,n,o]=t?t.split(":"):[],d=Date.UTC(Number(a),Number(i)-1,Number(l),Number(r),Number(n),Number(o)),m=Date.now();return d>=m})?((0,a.uX)(),(0,a.CE)("span",le,"Scheduled")):((0,a.uX)(),(0,a.CE)("span",re,"Failed"))])):((0,a.uX)(),(0,a.CE)("span",ne,"Scheduled"))])):((0,a.uX)(),(0,a.CE)("span",oe,[(()=>{const[e,s,a]=(t.scheduleDetails.schedule.date||"").split("-"),[i,l,r]=(t.scheduleDetails.schedule.time||"").split(":"),n=Date.UTC(Number(e),Number(s)-1,Number(a),Number(i),Number(l),Number(r)),o=Date.now();return n>=o})()?((0,a.uX)(),(0,a.CE)("span",de,"Scheduled")):((0,a.uX)(),(0,a.CE)("span",me,"Failed"))]))])]),t.scheduleDetails&&t.scheduleDetails.schedule?((0,a.uX)(),(0,a.CE)("div",ue,[(0,a.Lk)("div",ce,[(0,a.Lk)("div",he,[(0,a.Lk)("div",pe,[r.filteredEmails&&r.filteredEmails.length?((0,a.uX)(),(0,a.CE)("table",ge,[(0,a.bF)(n,{columns:[{label:"Group",key:"group",minWidth:"200px"},{label:"Members",key:"members",minWidth:"200px"},{label:"Email",key:"email",minWidth:"200px"},{label:"Member Roles",key:"member_roles",minWidth:"200px"}]}),(0,a.Lk)("tbody",null,[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(r.groupedEmails,(e,s)=>((0,a.uX)(),(0,a.CE)(a.FK,{key:"group-"+s},[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(e.items,(t,i)=>((0,a.uX)(),(0,a.CE)("tr",{key:"email-"+s+"-"+i},[0===i?((0,a.uX)(),(0,a.CE)("td",{key:0,rowspan:e.items.length,class:"group-cell"},(0,o.v_)(e.name||"Ungrouped"),9,be)):(0,a.Q3)("",!0),(0,a.Lk)("td",ye,(0,o.v_)(t.member_id&&r.memberDetailMap[t.member_id]?r.memberDetailMap[t.member_id].name:t.recipient_email||t.email||t.to||"Unknown"),1),(0,a.Lk)("td",null,(0,o.v_)(t.member_id&&r.memberDetailMap[t.member_id]?r.memberDetailMap[t.member_id].email:t.recipient_email||t.email||t.to||""),1),(0,a.Lk)("td",null,(0,o.v_)(t.member_id&&r.memberDetailMap[t.member_id]?r.memberDetailMap[t.member_id].rolesDisplay:Array.isArray(t.memberRoles)&&t.memberRoles.length?t.memberRoles.map(e=>e&&(e.name||e)||e).join(", "):Array.isArray(t.member_role_ids)&&t.member_role_ids.length?t.member_role_ids.map(e=>e&&(e.name||e)||e).join(", "):t.member_role||""),1)]))),128))],64))),128))])])):(0,a.Q3)("",!0)])])])])):((0,a.uX)(),(0,a.CE)("div",fe,[...s[5]||(s[5]=[(0,a.Lk)("em",null,"No schedule details found.",-1)])]))])):"Member Wise"===l.tab?((0,a.uX)(),(0,a.CE)("div",ke,[s[9]||(s[9]=(0,a.Lk)("br",null,null,-1)),(0,a.Lk)("div",ve,[(0,a.Lk)("div",we,[(0,a.Lk)("div",null,[(0,a.Lk)("div",Ae,(0,o.v_)(t.scheduleDetails.assessment.name),1),s[7]||(s[7]=(0,a.eW)(" - ",-1)),(0,a.Lk)("div",Se,(0,o.v_)(r.formatLocalDateTime(t.scheduleDetails.schedule.date,t.scheduleDetails.schedule.time)),1)])]),(0,a.Lk)("div",_e,[t.scheduleDetails.emails&&t.scheduleDetails.emails.length?((0,a.uX)(),(0,a.CE)("span",De,[r.filteredEmails.length&&r.filteredEmails.every(e=>e.sent)?((0,a.uX)(),(0,a.CE)("span",xe,"Sent")):r.filteredEmails.length&&r.filteredEmails.some(e=>!e.sent)&&r.filteredEmails.some(e=>e.sent)?((0,a.uX)(),(0,a.CE)("span",Ce,"Scheduled")):r.filteredEmails.length&&r.filteredEmails.every(e=>!e.sent)?((0,a.uX)(),(0,a.CE)("span",Le,[r.filteredEmails.some(e=>{const[s,t]=(e.send_at||"").split(" "),[a,i,l]=s?s.split("-"):[],[r,n,o]=t?t.split(":"):[],d=Date.UTC(Number(a),Number(i)-1,Number(l),Number(r),Number(n),Number(o)),m=Date.now();return d>=m})?((0,a.uX)(),(0,a.CE)("span",Ee,"Scheduled")):((0,a.uX)(),(0,a.CE)("span",Me,"Failed"))])):((0,a.uX)(),(0,a.CE)("span",Ne,"Scheduled"))])):((0,a.uX)(),(0,a.CE)("span",$e,[(()=>{const[e,s,a]=(t.scheduleDetails.schedule.date||"").split("-"),[i,l,r]=(t.scheduleDetails.schedule.time||"").split(":"),n=Date.UTC(Number(e),Number(s)-1,Number(a),Number(i),Number(l),Number(r)),o=Date.now();return n>=o})()?((0,a.uX)(),(0,a.CE)("span",Te,"Scheduled")):((0,a.uX)(),(0,a.CE)("span",ze,"Failed"))]))])]),(0,a.Lk)("div",Xe,[(0,a.Lk)("div",Fe,[(0,a.Lk)("div",Ie,[r.memberWiseRows&&r.memberWiseRows.length?((0,a.uX)(),(0,a.CE)("table",We,[(0,a.bF)(n,{columns:[{label:"Member Name",key:"name",minWidth:"200px"},{label:"Email",key:"email",minWidth:"200px"},{label:"Groups",key:"groups",minWidth:"200px"},{label:"Member Roles",key:"rolesDisplay",minWidth:"200px"}]}),(0,a.Lk)("tbody",null,[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(r.memberWiseRows,e=>((0,a.uX)(),(0,a.CE)("tr",{key:"memberwise-"+e.id},[(0,a.Lk)("td",null,(0,o.v_)(e.name),1),(0,a.Lk)("td",null,(0,o.v_)(e.email),1),(0,a.Lk)("td",null,(0,o.v_)(e.groups&&e.groups.length?e.groups.join(", "):""),1),(0,a.Lk)("td",null,(0,o.v_)(e.rolesDisplay||""),1)]))),128))])])):((0,a.uX)(),(0,a.CE)("div",Pe,[...s[8]||(s[8]=[(0,a.Lk)("em",null,"No members found for Member Wise view.",-1)])]))])])])])):(0,a.Q3)("",!0)])):(0,a.Q3)("",!0)])}var qe=t(5629);const Be={name:"ScheduleDetailsModal",components:{TableHeader:qe.A},props:{scheduleDetails:{type:Object,default:null},allGroups:{type:Array,default:()=>[]},allMembers:{type:Array,default:()=>[]}},emits:["close"],data(){return{tab:"Group Wise"}},computed:{memberDetailMap(){const e={};return this.scheduleDetails&&this.scheduleDetails.members_with_details&&this.scheduleDetails.members_with_details.forEach(s=>{const t=Array.isArray(s.member_roles)&&s.member_roles.length?s.member_roles.map(e=>e.name||e).join(", "):"";e[s.id]={name:s.name||"Unknown",email:s.email||"",memberRoles:s.member_roles||[],rolesDisplay:t}}),this.scheduleDetails&&this.scheduleDetails.groups_with_members&&this.scheduleDetails.groups_with_members.forEach(s=>{s.members&&Array.isArray(s.members)&&s.members.forEach(s=>{if(!e[s.id]){const t=Array.isArray(s.member_roles)&&s.member_roles.length?s.member_roles.map(e=>e.name||e).join(", "):"";e[s.id]={name:s.name||"Unknown",email:s.email||"",memberRoles:s.member_roles||[],rolesDisplay:t}}})}),0===Object.keys(e).length&&(this.allMembers||[]).forEach(s=>{const t=(s.first_name||s.name||"").toString().trim(),a=(s.last_name||"").toString().trim();let i=t;a&&(i=i?`${i} ${a}`:a),i||(i=s.email||`Member ${s.id}`);let l=[];l=Array.isArray(s.memberRoles)&&s.memberRoles.length?s.memberRoles.map(e=>"object"===typeof e?e:{id:e,name:String(e)}):Array.isArray(s.member_role_ids)&&s.member_role_ids.length?s.member_role_ids.map(e=>({id:e,name:String(e)})):[];const r=Array.isArray(l)&&l.length?l.map(e=>e.name||e).join(", "):s.member_role||"";e[s.id]={name:i,email:s.email||"",memberRoles:l,rolesDisplay:r}}),e},filteredEmails(){if(!this.scheduleDetails||!this.scheduleDetails.emails)return[];const e=this.scheduleDetails.schedule;return e?(this.scheduleDetails.emails||[]).filter(e=>e&&e.assessment_id===this.scheduleDetails.assessment.id):[]},groupedEmails(){const e=this.filteredEmails||[],s=this.scheduleDetails&&this.scheduleDetails.schedule||null,t=new Map,a=e=>{if(!e)return[];if(Array.isArray(e))return e.map(e=>Number(e));try{const s=JSON.parse(e);if(Array.isArray(s))return s.map(e=>Number(e))}catch(s){return console.warn("Failed to parse array field:",s),e.toString().replace(/\[|\]|\s+/g,"").split(",").filter(Boolean).map(e=>Number(e))}return[]},i=s?a(s.group_ids):[];return i&&i.length?(i.forEach(s=>{const a=(this.allGroups||[]).find(e=>Number(e.id)===Number(s)),i=a&&(a.name||a.group)||`Group ${s}`,l=[];e.forEach(e=>{const t=new Set;if(e.group_id&&t.add(Number(e.group_id)),e.group_ids)try{const s=Array.isArray(e.group_ids)?e.group_ids:JSON.parse(e.group_ids);Array.isArray(s)&&s.forEach(e=>t.add(Number(e)))}catch{console.warn("Failed to parse email group_ids field")}t.has(Number(s))&&l.push(e)});let r=[];a&&Array.isArray(a.members)&&a.members.length&&(r=a.members.map(e=>Number(e.id||e.member_id||e))),r.length||(r=(this.allMembers||[]).filter(e=>{const t=Array.isArray(e.group_ids)?e.group_ids:[];return t.some(e=>Number(e)===Number(s))||Number(e.group_id)===Number(s)}).map(e=>Number(e.id))),(r||[]).forEach(e=>{const s=l.some(s=>Number(s.member_id)===Number(e));s||l.push({member_id:e})}),t.set(s,{id:s,name:i,items:l})}),Array.from(t.values()).forEach(e=>{e.items=(e.items||[]).filter(Boolean)}),Array.from(t.values())):(e.forEach(e=>{const s=e.group_id||e.group||"ungrouped",a=e.group_name||e.group||("ungrouped"===s?"Ungrouped":null);t.has(s)||t.set(s,{id:s,name:a||"Group",items:[]}),t.get(s).items.push(e)}),Array.from(t.values()).forEach(e=>{e.items=(e.items||[]).filter(Boolean)}),Array.from(t.values()))},memberWiseRows(){const e=[],s=this.scheduleDetails&&this.scheduleDetails.schedule||null,t=e=>{if(!e)return[];if(Array.isArray(e))return e.map(e=>Number(e));try{const s=JSON.parse(e);if(Array.isArray(s))return s.map(e=>Number(e))}catch{}return e.toString().replace(/\[|\]|\s+/g,"").split(",").filter(Boolean).map(e=>Number(e))},a=s?t(s.member_ids):[],i=(this.filteredEmails||[]).filter(Boolean).map(e=>Number(e.member_id)).filter(Boolean),l=new Set(a.length?a:i);return Array.from(l).forEach(s=>{const t=this.memberDetailMap[s]||{name:`Member ${s}`,email:""};let a=[];const i=(this.allGroups||[]).filter(e=>Array.isArray(e.members)&&e.members.some(e=>Number(e.id||e.member_id||e)===Number(s))).map(e=>Number(e.id));a=i&&i.length?i:(this.filteredEmails||[]).filter(Boolean).filter(e=>Number(e.member_id)===Number(s)&&(e.group_id||e.group)).map(e=>Number(e.group_id||e.group));const l=Array.from(new Set(a)),r=(l||[]).map(e=>{const s=(this.allGroups||[]).find(s=>Number(s.id)===Number(e));return s&&(s.name||s.group)||`Group ${e}`});e.push({id:s,name:t.name,email:t.email,groups:r,rolesDisplay:t.rolesDisplay||""})}),e}},methods:{formatLocalDateTime(e,s){if(!e)return"";try{const{year:t,month:a,day:i}=this.parseDateString(e),{hour:l,minute:r,second:n}=this.parseTimeString(s),o=new Date(t,a,i,l,r,n);return isNaN(o.getTime())?e+(s?" "+s:""):this.formatDisplayTime(o)}catch{return e+(s?" "+s:"")}},parseDateString(e){const s=(e||"").toString().trim(),t=s.match(/^(\d{4})-(\d{2})-(\d{2})$/);if(t)return{year:Number(t[1]),month:Number(t[2])-1,day:Number(t[3])};const a=new Date(s);if(isNaN(a.getTime()))throw new Error("Invalid date");return{year:a.getFullYear(),month:a.getMonth(),day:a.getDate()}},parseTimeString(e){const s=(e||"").toString().trim(),t=s.match(/^(\d{2}):(\d{2})(?::(\d{2}))?$/);return t?{hour:Number(t[1]),minute:Number(t[2]),second:t[3]?Number(t[3]):0}:{hour:0,minute:0,second:0}},formatDisplayTime(e){const s=String(e.getDate()).padStart(2,"0"),t=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],a=t[e.getMonth()],i=e.getFullYear();let l=e.getHours();const r=String(e.getMinutes()).padStart(2,"0"),n=l>=12?"PM":"AM";return l%=12,l=l||12,`${s} ${a},${i} ${l}:${r} ${n}`}}},Qe=(0,Q.A)(Be,[["render",Ge],["__scopeId","data-v-f4e61264"]]),Ue=Qe,Oe={class:"modal-overlay"},Re={class:"modal-card"},je={class:"modal-form-row"},Ke={class:"modal-form-group",style:{padding:"0 0",background:"none","border-radius":"0",height:"auto"}},Ve={class:"modal-form-row",style:{"flex-direction":"column","align-items":"stretch",gap:"10px"}},Je={style:{"flex-direction":"row-reverse","align-items":"center",display:"flex",width:"100%","margin-bottom":"8px",border:"white",background:"white"}},He=["checked"],Ye=["for"],Ze=["id","value"],es={style:{flex:"1","text-align":"left","font-size":"18px","font-weight":"500",color:"#222"}},ss={class:"modal-form-actions"},ts=["disabled"];function as(e,s,t,i,l,r){return(0,a.uX)(),(0,a.CE)("div",Oe,[(0,a.Lk)("div",Re,[(0,a.Lk)("button",{class:"modal-close",onClick:s[0]||(s[0]=s=>e.$emit("close"))}," × "),s[10]||(s[10]=(0,a.Lk)("div",{class:"modal-title"},"Create Assessment",-1)),(0,a.Lk)("form",{class:"modal-form",onSubmit:s[5]||(s[5]=(0,S.D$)((...e)=>r.handleSubmit&&r.handleSubmit(...e),["prevent"]))},[(0,a.Lk)("div",je,[(0,a.Lk)("div",Ke,[(0,a.bo)((0,a.Lk)("input",{"onUpdate:modelValue":s[1]||(s[1]=e=>l.assessment.name=e),type:"text",placeholder:"Assessment Name",required:"",style:{width:"100%",background:"#f6f6f6","border-radius":"9px",border:"1.5px solid #e0e0e0","font-size":"20px",padding:"16px 20px","box-sizing":"border-box","font-weight":"500",color:"#222"}},null,512),[[S.Jo,l.assessment.name]])])]),(0,a.Lk)("div",Ve,[s[9]||(s[9]=(0,a.Lk)("label",{for:"questions",style:{"font-weight":"600","margin-bottom":"16px","font-size":"22px","text-align":"left",display:"block","align-self":"flex-start"}}," Questions ",-1)),(0,a.Lk)("div",Je,[(0,a.Lk)("label",{class:(0,o.C4)(["user-assessment-checkbox-label",{checked:r.allSelected}]),style:{display:"flex","align-items":"center","justify-content":"flex-end !important","font-size":"12px !important",padding:"18px 24px",background:"white","border-radius":"12px","margin-bottom":"0","text-align":"left","max-width":"200px !important",border:"white"}},[s[6]||(s[6]=(0,a.Lk)("span",{class:"user-assessment-checkbox-custom"},null,-1)),(0,a.Lk)("input",{type:"checkbox",checked:r.allSelected,onChange:s[2]||(s[2]=e=>r.toggleSelectAll(e.target.checked))},null,40,He),s[7]||(s[7]=(0,a.Lk)("span",{style:{flex:"1","text-align":"right","font-size":"18px","font-weight":"500",color:"#222"}},"Select All",-1))],2)]),((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(t.questions,e=>((0,a.uX)(),(0,a.CE)("div",{key:e.id,style:{width:"100%","margin-bottom":"8px"}},[(0,a.Lk)("label",{for:"q-"+e.id,class:(0,o.C4)(["user-assessment-checkbox-label",{checked:l.assessment.selectedQuestionIds.includes(e.id)}]),style:{"justify-content":"flex-start","font-size":"18px",padding:"18px 24px",background:"#f8f9fb","border-radius":"12px","margin-bottom":"0","text-align":"left"}},[s[8]||(s[8]=(0,a.Lk)("span",{class:"user-assessment-checkbox-custom"},null,-1)),(0,a.bo)((0,a.Lk)("input",{type:"checkbox",id:"q-"+e.id,value:e.id,"onUpdate:modelValue":s[3]||(s[3]=e=>l.assessment.selectedQuestionIds=e)},null,8,Ze),[[S.lH,l.assessment.selectedQuestionIds]]),(0,a.Lk)("span",es,(0,o.v_)(e.text),1)],10,Ye)]))),128))]),(0,a.Lk)("div",ss,[(0,a.Lk)("button",{type:"submit",class:"modal-save-btn",disabled:l.isSubmitting},(0,o.v_)(l.isSubmitting?"Creating...":"Create"),9,ts),(0,a.Lk)("button",{type:"button",class:"org-edit-cancel",onClick:s[4]||(s[4]=s=>e.$emit("close")),style:{"margin-left":"12px"}}," Cancel ")])],32)])])}const is={name:"CreateAssessmentModal",props:{questions:{type:Array,required:!0,default:()=>[]}},emits:["close","assessment-created"],data(){return{assessment:{name:"",selectedQuestionIds:[]},isSubmitting:!1}},methods:{resetForm(){this.assessment={name:"",selectedQuestionIds:[]},this.isSubmitting=!1},toggleSelectAll(e){this.assessment.selectedQuestionIds=e?this.questions.map(e=>e.id):[]},async handleSubmit(){const e=this.questions.filter(e=>this.assessment.selectedQuestionIds.includes(e.id));if(this.assessment.name&&0!==e.length){this.isSubmitting=!0;try{const e=G["default"].get("authToken"),s=await P.A.post("http://127.0.0.1:8000/api/assessments",{name:this.assessment.name,question_ids:this.assessment.selectedQuestionIds},{headers:{Authorization:`Bearer ${e}`}});s.data&&s.data.assessment&&(this.$emit("assessment-created",s.data.assessment),this.resetForm(),this.$emit("close"))}catch(s){console.error("Error creating assessment",s),this.$emit("error",{type:"error",title:"Error",message:s.response&&s.response.data&&s.response.data.message||"Failed to create assessment. Please try again."})}finally{this.isSubmitting=!1}}else this.$emit("validation-error",{type:"warn",title:"Missing Data",message:"Please enter a name and select at least one question."})}},computed:{allSelected(){return!(!Array.isArray(this.questions)||0===this.questions.length)&&this.questions.every(e=>this.assessment.selectedQuestionIds.includes(e.id))}},mounted(){this.resetForm()}},ls=(0,Q.A)(is,[["render",as]]),rs=ls,ns={name:"OrganizationAdminAssessmentsCard",components:{Pagination:A.A,ScheduleAssessmentModal:O,ScheduleDetailsModal:Ue,CreateAssessmentModal:rs,TableHeader:qe.A},data(){return{assessments:[],showScheduleModal:!1,selectedAssessment:null,showCreateModal:!1,questions:[],pageSize:10,currentPage:1,showPageDropdown:!1,showGroupsDropdown:!1,showMembersDropdown:!1,loading:!1,toast:null,showScheduleDetailsModal:!1,scheduleDetails:null,allGroups:[],allMembers:[]}},created(){this.toast=(0,q.d)()},computed:{paginatedAssessments(){const e=(this.currentPage-1)*this.pageSize;return this.assessments.slice(e,e+this.pageSize)},totalPages(){return Math.ceil(this.assessments.length/this.pageSize)||1},groupNameMap(){const e={};return(this.allGroups||[]).forEach(s=>{e[s.id]=s.name}),e},memberNameMap(){const e={};return(this.allMembers||[]).forEach(s=>{const t=(s.first_name||s.name||"").toString().trim(),a=(s.last_name||"").toString().trim(),i=(s.member_role||s.role||"").toString().trim();let l=t;a&&(l=l?`${l} ${a}`:a),l||(l=s.email||s.id||"Unknown"),i&&(l=`${l} — ${i}`),e[s.id]=l}),e},memberDetailMap(){const e={};return(this.allMembers||[]).forEach(s=>{const t=(s.first_name||s.name||"").toString().trim(),a=(s.last_name||"").toString().trim();let i=t;a&&(i=i?`${i} ${a}`:a),i||(i=s.email||`Member ${s.id}`),e[s.id]={name:i,email:s.email||"",role:(s.member_role||s.role||"").toString().trim()||""}}),e}},methods:{_showToast(e,s,t,a=3500,i=!1){const l=this.toast||this.$toast;try{i&&"undefined"!==typeof document&&document.body.classList.add("toast-above-modal")}catch(r){console.warn("Failed to set toast-above-modal class",r)}l&&"function"===typeof l.add?l.add({severity:e,summary:s,detail:t,life:a}):this&&this.$toast&&"function"===typeof this.$toast.add?this.$toast.add({severity:e,summary:s,detail:t,life:a}):"undefined"!==typeof window&&window.$toast&&"function"===typeof window.$toast.add?window.$toast.add({severity:e,summary:s,detail:t,life:a}):console["warn"===e?"warn":"log"](`${s}: ${t}`),i&&"undefined"!==typeof window&&setTimeout(()=>{try{document.body.classList.remove("toast-above-modal")}catch(r){console.warn("Failed to remove toast-above-modal class",r)}},a+300)},async openScheduleDetails(e){try{const s=await P.A.get("http://127.0.0.1:8000/api/scheduled-email/show",{params:{assessment_id:e.id}});this.scheduleDetails=s.data,console.log("[OrganizationAdminAssessmentsCard] schedule details response for",e.id,s.data)}catch(s){this.scheduleDetails=null,console.error("[OrganizationAdminAssessmentsCard] failed to fetch schedule details for",e.id,s&&s.message)}this.selectedAssessment=e,this.showScheduleDetailsModal=!0},onScheduleButtonClick(e){try{console.log("[OrganizationAdminAssessmentsCard] schedule button clicked:",{id:e&&e.id,hasSchedule:!(!e||!e.schedule),item:e})}catch(s){console.log("[OrganizationAdminAssessmentsCard] schedule button click - failed to stringify item",s)}e&&e.schedule?this.openScheduleDetails(e):this.openScheduleModal(e)},formatLocalDateTime(e,s){if(!e)return"";try{const t=(e||"").toString().trim(),a=(s||"").toString().trim(),i=t.match(/^(\d{4})-(\d{2})-(\d{2})$/),l=a.match(/^(\d{2}):(\d{2})(?::(\d{2}))?$/);let r,n,o,d,m,u;if(i)r=Number(i[1]),n=Number(i[2])-1,o=Number(i[3]);else{const a=new Date(t);if(isNaN(a.getTime()))return e+(s?" "+s:"");r=a.getFullYear(),n=a.getMonth(),o=a.getDate()}l?(d=Number(l[1]),m=Number(l[2]),u=l[3]?Number(l[3]):0):(d=0,m=0,u=0);const c=new Date(r,n,o,d,m,u);if(isNaN(c.getTime()))return e+(s?" "+s:"");const h=String(c.getDate()).padStart(2,"0"),p=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],g=p[c.getMonth()],b=c.getFullYear();let y=c.getHours();const f=String(c.getMinutes()).padStart(2,"0"),k=y>=12?"PM":"AM";return y%=12,y=y||12,`${h} ${g},${b} ${y}:${f} ${k}`}catch(t){return console.error("Failed to format date/time",t),e+(s?" "+s:"")}},formatSendAt(e){if(!e)return"";try{const s=(e||"").toString().trim();if(s.includes("T")){const e=new Date(s);if(isNaN(e.getTime()))return s;const t=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),i=String(e.getDate()).padStart(2,"0"),l=String(e.getHours()).padStart(2,"0"),r=String(e.getMinutes()).padStart(2,"0");return this.formatLocalDateTime(`${t}-${a}-${i}`,`${l}:${r}`)}if(s.includes(" ")){const[e,t]=s.split(" "),a=(t||"").split(":").slice(0,2).join(":");return this.formatLocalDateTime(e,a)}return s}catch(s){return console.error("Failed to format sendAt",s),e}},closeScheduleDetailsModal(){this.showScheduleDetailsModal=!1,this.scheduleDetails=null},async openScheduleModal(e){try{const s=await P.A.get("http://127.0.0.1:8000/api/scheduled-email/show",{params:{assessment_id:e.id}});return console.log("Scheduled check response:",s.data),!s.data||!0!==s.data.scheduled&&1!==s.data.scheduled?!s.data||!1!==s.data.scheduled&&0!==s.data.scheduled?(console.warn("Unexpected schedule status from backend, defaulting to details view:",s.data),void this.openScheduleDetails(e)):(this.selectedAssessment=e,void(this.showScheduleModal=!0)):void this.openScheduleDetails(e)}catch(s){return console.error("Schedule check error:",s),void this.toast.add({severity:"error",summary:"Error",detail:"Could not check schedule status.",life:3500})}},closeScheduleModal(){this.showScheduleModal=!1,this.selectedAssessment=null,this.showGroupsDropdown=!1,this.showMembersDropdown=!1},async goToSummary(e){try{const s=await P.A.get("http://127.0.0.1:8000/api/scheduled-email/show",{params:{assessment_id:e.id}});if(s&&s.data&&(!0===s.data.scheduled||1===s.data.scheduled))return void this.$router.push({name:"AssessmentSummary",params:{assessmentId:e.id,assessment:e}});if(s&&s.data&&(!1===s.data.scheduled||0===s.data.scheduled)){const e="Assessment is not yet scheduled. Please schedule it first.";return void this._showToast("info","Not Scheduled",e,4e3)}this.$router.push({name:"AssessmentSummary",params:{assessmentId:e.id,assessment:e}})}catch(s){console.error("Schedule check error:",s);const e="Could not verify schedule status. Try again later.";return void this._showToast("error","Error",e)}},goToPage(e){e>=1&&e<=this.totalPages&&(this.currentPage=e)},selectPageSize(e){this.pageSize=e,this.currentPage=1,this.showPageDropdown=!1},closeCreateModal(){this.showCreateModal=!1},handleAssessmentCreated(e){this.assessments.unshift(e)},handleValidationError(e){this._showToast(e.type,e.title,e.message,4e3,!0)},handleError(e){this._showToast(e.type,e.title,e.message,3500)},async handleScheduleAssessment({date:e,time:s,groupIds:t,memberIds:a,selectedMembers:i}){if(this.selectedAssessment&&e&&s)try{const l=G["default"].get("authToken");await P.A.post("http://127.0.0.1:8000/api/assessment-schedules",{assessment_id:this.selectedAssessment.id,date:e,time:s,group_ids:t,member_ids:a},{headers:{Authorization:`Bearer ${l}`}});const r=new Date(`${e}T${s}:00`),n=r.toISOString(),o="Assessment Scheduled",d="You have an assessment scheduled.";for(const e of i||[])if(e.email){let s=null;Array.isArray(e.group_ids)&&e.group_ids.length>0?s=e.group_ids[0]:e.group_id?s=e.group_id:Array.isArray(t)&&1===t.length?s=t[0]:console.warn("No group_id found for member",e),await P.A.post("http://127.0.0.1:8000/api/schedule-email",{recipient_email:e.email,subject:o,body:d,send_at:n,assessment_id:this.selectedAssessment.id,member_id:e.id,group_id:s},{headers:{Authorization:`Bearer ${l}`}})}this.closeScheduleModal(),this.toast.add({severity:"success",summary:"Scheduled",detail:"Assessment scheduled and emails queued!",life:3500})}catch(l){console.error("Failed to schedule assessment or emails",l),this.toast.add({severity:"error",summary:"Error",detail:"Failed to schedule assessment or emails.",life:3500})}else this.toast.add({severity:"warn",summary:"Missing Data",detail:"Please select assessment, date, and time.",life:3500})}},mounted:async function(){this.loading=!0;try{const t=G["default"].get("authToken"),a=G["default"].get("user_id"),i=G["default"].get("organization_id")||G["default"].get("org_id")||G["default"].get("organizationId")||G["default"].get("orgId")||G["default"].get("user")&&G["default"].get("user").organization_id||null,l={};i?l.organization_id=i:a?l.user_id=a:console.warn("[OrganizationAdminAssessmentsCard] No orgId or userId found in storage");const r="http://127.0.0.1:8000";if(0===Object.keys(l).length&&t)try{const e=await P.A.get(r+"/api/profile",{headers:{Authorization:`Bearer ${t}`}}),s=e.data||{},a=s.organization_id||s.user&&s.user.organization_id||null;a&&(l.organization_id=a)}catch(e){console.warn("[OrganizationAdminAssessmentsCard] failed to fetch profile",e&&e.message)}const n=await P.A.get(r+"/api/assessments",{headers:{Authorization:`Bearer ${t}`},params:l});Array.isArray(n.data.assessments)?this.assessments=n.data.assessments:Array.isArray(n.data)?this.assessments=n.data:this.assessments=[];try{const s=this.paginatedAssessments||[],a=s.map(async s=>{try{const e=await P.A.get(r+"/api/scheduled-email/show",{params:{assessment_id:s.id},headers:{Authorization:`Bearer ${t}`}});return!e.data||!0!==e.data.scheduled&&1!==e.data.scheduled?{...s,schedule:null}:{...s,schedule:e.data}}catch(e){return console.warn(`[OrganizationAdminAssessmentsCard] Failed to fetch schedule for assessment ${s.id}`,e&&e.message),{...s,schedule:null}}}),i=await Promise.all(a),l=new Map(i.map(e=>[e.id,e]));this.assessments=this.assessments.map(e=>l.get(e.id)||e)}catch(s){console.warn("[OrganizationAdminAssessmentsCard] Failed to pre-fetch schedule statuses.",s)}const o=await P.A.get("http://127.0.0.1:8000/api/organization-assessment-questions",{headers:{Authorization:`Bearer ${t}`}});Array.isArray(o.data.questions)?this.questions=o.data.questions:Array.isArray(o.data)?this.questions=o.data:this.questions=[];const d=await P.A.get("http://127.0.0.1:8000/api/groups",{headers:{Authorization:`Bearer ${t}`}});Array.isArray(d.data.groups)?this.allGroups=d.data.groups:Array.isArray(d.data)?this.allGroups=d.data:this.allGroups=[];const m=await P.A.get("http://127.0.0.1:8000/api/members",{headers:{Authorization:`Bearer ${t}`}});Array.isArray(m.data.members)?this.allMembers=m.data.members:Array.isArray(m.data)?this.allMembers=m.data:this.allMembers=[]}catch(e){console.error("[OrganizationAdminAssessmentsCard] Failed to fetch assessments or questions",e&&e.message),this.assessments=[],this.questions=[]}finally{this.loading=!1}}},os=(0,Q.A)(ns,[["render",w],["__scopeId","data-v-539e4650"]]),ds=os,ms={class:"user-assessment-outer"},us={class:"user-assessment-card"},cs={class:"user-assessment-header"},hs={class:"user-assessment-title"},ps={class:"user-assessment-table-container"},gs={class:"user-assessment-words-grid"},bs=["value"],ys={class:"user-assessment-footer"},fs={style:{flex:"1",display:"flex","align-items":"center"}},ks={class:"user-assessment-step-btn"},vs={style:{flex:"1",display:"flex","justify-content":"flex-end","align-items":"center",gap:"12px"}},ws=["disabled"],As=["disabled"],Ss={key:1,class:"user-assessment-success-card"};function _s(e,s,t,i,l,r){return(0,a.uX)(),(0,a.CE)("div",ms,[(0,a.Lk)("div",us,[i.submitted?((0,a.uX)(),(0,a.CE)("div",Ss,[s[7]||(s[7]=(0,a.Fv)('<div class="user-assessment-success-icon" data-v-63d5ee7a><svg width="80" height="80" viewBox="0 0 80 80" fill="none" data-v-63d5ee7a><circle cx="40" cy="40" r="40" fill="#2ECC40" data-v-63d5ee7a></circle><path d="M25 42l13 13 17-23" stroke="#fff" stroke-width="5" stroke-linecap="round" stroke-linejoin="round" data-v-63d5ee7a></path></svg></div><div class="user-assessment-success-title" data-v-63d5ee7a> Assessment submitted successfully and processed! </div><div class="user-assessment-success-desc" data-v-63d5ee7a> Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry&#39;s standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book. It has survived not only five centuries, but also the leap into electronic typesetting, remaining essentially unchanged </div>',3)),i.isSubscribed?((0,a.uX)(),(0,a.CE)("button",{key:0,class:"user-assessment-success-btn",onClick:s[4]||(s[4]=(...e)=>i.goToManageSubscription&&i.goToManageSubscription(...e))}," Manage Subscription ")):((0,a.uX)(),(0,a.CE)("button",{key:1,class:"user-assessment-success-btn",onClick:s[5]||(s[5]=(...e)=>i.explorePlans&&i.explorePlans(...e))}," Explore Subscriptions ")),s[8]||(s[8]=(0,a.Lk)("div",{style:{"margin-top":"16px"}},null,-1))])):((0,a.uX)(),(0,a.CE)(a.FK,{key:0},[(0,a.Lk)("div",cs,[(0,a.Lk)("div",hs,(0,o.v_)(i.currentQuestion.question||`Question ${i.step}`),1)]),(0,a.Lk)("div",ps,[(0,a.Lk)("div",gs,[((0,a.uX)(!0),(0,a.CE)(a.FK,null,(0,a.pI)(i.currentQuestion.options,e=>((0,a.uX)(),(0,a.CE)("label",{key:e,class:(0,o.C4)(["user-assessment-checkbox-label",{checked:i.currentSelectedWords.includes(e)}])},[s[6]||(s[6]=(0,a.Lk)("span",{class:"user-assessment-checkbox-custom"},null,-1)),(0,a.bo)((0,a.Lk)("input",{type:"checkbox",value:e,"onUpdate:modelValue":s[0]||(s[0]=e=>i.selectedWords[i.step-1]=e)},null,8,bs),[[S.lH,i.selectedWords[i.step-1]]]),(0,a.eW)(" "+(0,o.v_)(e),1)],2))),128))])]),(0,a.Lk)("div",ys,[(0,a.Lk)("div",fs,[(0,a.Lk)("span",ks," Question "+(0,o.v_)(i.step)+" of "+(0,o.v_)(i.totalSteps),1)]),(0,a.Lk)("div",vs,[i.step>1?((0,a.uX)(),(0,a.CE)("button",{key:0,class:"user-assessment-back-btn",onClick:s[1]||(s[1]=(...e)=>i.goToBack&&i.goToBack(...e))}," Back ")):(0,a.Q3)("",!0),i.step<i.totalSteps?((0,a.uX)(),(0,a.CE)("button",{key:1,class:"user-assessment-next-btn",disabled:!i.canProceed,onClick:s[2]||(s[2]=(...e)=>i.goToNext&&i.goToNext(...e))}," Next ",8,ws)):((0,a.uX)(),(0,a.CE)("button",{key:2,class:"user-assessment-next-btn",disabled:!i.canProceed,onClick:s[3]||(s[3]=(...e)=>i.handleSubmit&&i.handleSubmit(...e))}," Submit ",8,As))])])],64))])])}var Ds=t(953),xs=t(5220),Cs=t(3413);const Ls="http://127.0.0.1:8000",Es={name:"UserAssessment",components:{Toast:Cs.A},setup(){const e=(0,xs.rd)(),s=(0,q.d)(),i=(0,Ds.KR)(1),l=(0,Ds.KR)([]),r=(0,Ds.KR)([]),n=(0,Ds.KR)(!1),o=(0,Ds.KR)(!1),d=(0,a.EW)(()=>l.value.length),m=(0,a.EW)(()=>l.value[i.value-1]||{question:"",options:[]}),u=(0,a.EW)(()=>r.value[i.value-1]||[]),c=(0,a.EW)(()=>r.value[i.value-1]&&r.value[i.value-1].length>0),h=async()=>{try{const e=t(3193)["default"],s=e.get("authToken"),i=e.get("user_id"),n={};s&&(n["Authorization"]=`Bearer ${s}`);const d={};i&&(d["user_id"]=i);const m=await P.A.get(`${Ls}/api/questions`,{headers:n,params:d});Array.isArray(m.data)&&(l.value=m.data,r.value=m.data.map(()=>[]));const u=await P.A.get(`${Ls}/api/answers`,{headers:n,params:d});Array.isArray(u.data)&&u.data.forEach(e=>{const s=l.value.findIndex(s=>String(s.id)===String(e.question_id));-1!==s&&Array.isArray(e.answer)&&(r.value[s]=e.answer)});try{const e=await P.A.get(`${Ls}/api/subscription/status`,{headers:n});o.value=!(!e.data||!e.data.active&&"active"!==e.data.status&&!e.data.subscribed)}catch(a){o.value="expired"}}catch(i){i.response&&401===i.response.status?e.push("/login"):s&&"function"===typeof s.add&&s.add({severity:"error",summary:"Load failed",detail:"Failed to load assessment questions or answers.",sticky:!0})}},p=()=>{i.value<d.value&&c.value&&i.value++},g=()=>{i.value>1&&i.value--},b=async()=>{if(!c.value)return;const a=t(3193)["default"],i=a.get("authToken");if(!i)return s&&"function"===typeof s.add&&s.add({severity:"warn",summary:"Not logged in",detail:"You must be logged in to submit an assessment.",sticky:!0}),void e.push("/login");const o=l.value.map((e,s)=>({question_id:e.id,answer:r.value[s]||[]}));try{await P.A.post(`${Ls}/api/answers`,{answers:o},{headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`}}),n.value=!0}catch(d){let t="Failed to submit assessment. Please try again.";d.response&&401===d.response.status&&(t="Your session has expired. Please log in again.",e.push("/login")),s&&"function"===typeof s.add&&s.add({severity:d.response&&401===d.response.status?"warn":"error",summary:"Submission failed",detail:t,sticky:!0})}};(0,a.sV)(h);const y=()=>{e.push({name:"ManageSubscription"})},f=()=>{e.push({name:"SubscriptionPlans"})};return{step:i,questions:l,selectedWords:r,submitted:n,totalSteps:d,currentQuestion:m,currentSelectedWords:u,canProceed:c,goToNext:p,goToBack:g,handleSubmit:b,goToManageSubscription:y,explorePlans:f,isSubscribed:o}}},Ms=(0,Q.A)(Es,[["render",_s],["__scopeId","data-v-63d5ee7a"]]),Ns=Ms,$s={name:"Assessments",components:{MainLayout:n.A,OrganizationAdminAssessmentsCard:ds,UserAssessment:Ns},computed:{isOrganizationAdmin(){const e=t(3193)["default"],s=e.get("role")||"user";return"organizationadmin"===s},isUser(){const e=t(3193)["default"],s=e.get("role")||"user";return"user"===s}}},Ts=(0,Q.A)($s,[["render",r],["__scopeId","data-v-3164d804"]]),zs=Ts}}]);
//# sourceMappingURL=183.218a62a3.js.map